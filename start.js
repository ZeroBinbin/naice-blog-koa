!function(e){var t={};function a(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,a),r.l=!0,r.exports}a.m=e,a.c=t,a.d=function(e,t,s){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)a.d(s,r,function(t){return e[t]}.bind(null,r));return s},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=14)}([function(e,t,a){"use strict";e.exports={MONGODB:{uri:"mongodb://127.0.0.1:27017/blogapi",prouri:"mongodb://xxxxx@xxxxx/blogapi"},QINIU:{accessKey:"your_qn_accessKey",secretKey:"your_qn_secretKey",bucket:"naice",origin:"xxxxxx",uploadURL:"your_qn_uploadURL"},User:{jwtTokenSecret:"naice_blog",defaultUsername:"naice",defaultPassword:"123456"},EMAIL:{service:"QQ",account:"xxxxx@xx.com",password:"xxxx"},BAIDU:{site:"blog.naice.me",token:"xxxxxxx"},APP:{ROOT_PATH:"/api",LIMIT:10,PORT:3009},INFO:{name:"by_blog",version:"1.0.0",author:"naice",site:"https://blog.naice.me",powered:["Vue2","Nuxt.js","Node.js","MongoDB","koa","Nginx"]}}},function(e,t,a){"use strict";e.exports=e=>async(t,a)=>{const{body:s}=t.request;if(e&&e.length>0){let a=[];for(let t=0;t<e.length;t++){let r=e[t];s.hasOwnProperty(r)||a.push(r)}a.length>0&&t.throw(412,`${a.join(", ")} 参数缺失`)}await a()}},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports={resError:({ctx:e,message:t="请求失败",err:a=null})=>{e.body={code:0,message:t,debug:a}},resSuccess:({ctx:e,message:t="请求成功",result:a=null})=>{e.body={code:1,message:t,result:a}}}},function(e,t){e.exports=require("mongoose-paginate")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("crypto")},function(e,t,a){"use strict";const s=a(2),r=a(4),n=new s.Schema({title:{type:String,required:!0},keyword:{type:String,required:!0},descript:{type:String,required:!0},tag:[{type:s.Schema.Types.ObjectId,ref:"Tag"}],content:{type:String,required:!0},editContent:{type:String,required:!0},state:{type:Number,default:1},publish:{type:Number,default:1},thumb:String,type:{type:Number,default:1},create_at:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now},meta:{views:{type:Number,default:0},likes:{type:Number,default:0},comments:{type:Number,default:0}}});n.plugin(r),n.pre("findOneAndUpdate",function(e){this.findOneAndUpdate({},{update_at:Date.now()}),e()});const i=s.model("Article",n);e.exports=i},function(e,t){e.exports=require("xss")},function(e,t,a){const s=a(2),r=a(6),n=a(0),i=new s.Schema({name:{type:String,default:"naice"},username:{type:String,default:n.User.defaultUsername},slogan:{type:String,default:""},gravatar:{type:String,default:""},password:{type:String,default:r.createHash("md5").update(n.User.defaultPassword).digest("hex")},role:{type:Number,default:1}}),o=s.model("User",i);e.exports=o},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,a){"use strict";const s=a(2),r=a(4),n=new s.Schema({post_id:{type:String,required:!0},pid:{type:Number,default:0},content:{type:String,required:!0,validate:/\S+/},likes:{type:Number,default:0},ip:{type:String},city:{type:String},range:{type:String},country:{type:String},agent:{type:String,validate:/\S+/},author:{gravatar:{type:String,default:0},name:{type:String,required:!0,validate:/\S+/},email:{type:String,required:!0,validate:/\w[-\w.+]*@([A-Za-z0-9][-A-Za-z0-9]+\.)+[A-Za-z]{2,14}/},site:{type:String}},state:{type:Number,default:1},reply:{type:Number,default:0},create_at:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now}});n.plugin(r),n.pre("findOneAndUpdate",function(e){this.findOneAndUpdate({},{update_at:Date.now()}),e()});const i=s.model("Comment",n);e.exports=i},function(e,t){e.exports=require("geoip-lite")},function(e,t,a){const s=a(0),r=a(35);let n=!1;const i=r.createTransport({service:s.EMAIL.service,secure:!0,secureConnection:!0,port:465,auth:{user:s.EMAIL.account,pass:s.EMAIL.password}}),o=()=>{i.verify((e,t)=>{e?(n=!1,console.warn("邮件客户端初始化连接失败，将在一小时后重试"),setTimeout(o,36e5)):(n=!0,console.log("邮件客户端初始化连接成功，随时可发送邮件"))})};o();e.exports={sendMail:e=>{if(!n)return console.warn("由于未初始化成功，邮件客户端发送被拒绝"),!1;e.from='"何文林" <370215230@qq.com>',i.sendMail(e,(e,t)=>{if(e)return console.warn("邮件发送失败",e);console.log("邮件发送成功",t.messageId,t.response)})},nodemailer:r,transporter:i}},function(e,t,a){"use strict";const s=a(15),r=a(0),n=a(16),i=a(20),o=a(26),c=new s;n(),i(c),c.use(o.routes()),c.use(o.allowedMethods()),c.listen(r.APP.PORT,()=>{console.log(`node-Koa Run！port at ${r.APP.PORT}`)})},function(e,t){e.exports=require("koa")},function(e,t,a){"use strict";(function(t){const s=a(17),r=a(2),n=a(4),{resolve:i}=a(5),o=a(0),c=a(18),u=o.MONGODB.uri;r.Promise=global.Promise,r.set("debug",!0),s.sync(i(t,"../models/*.js")).forEach(a(19)),e.exports=function(){return r.connect(u),r.connection.on("error",e=>{console.log("数据库连接失败!",e)}),r.connection.once("open",()=>{console.log("数据库连接成功!"),n.paginate.options={limit:o.APP.LIMIT},c()}),r}}).call(this,"/")},function(e,t){e.exports=require("glob")},function(e,t,a){"use strict";const s=a(6),r=a(0),n=a(9);e.exports=async()=>{const e=r.User.defaultUsername,t=(e=>s.createHash("md5").update(e).digest("hex"))(r.User.defaultPassword);let a=await n.find({}).exec().catch(e=>{console.log(500,"服务器内部错误-查找admin错误！")});if(console.log(a),0===a.length){let a=new n({username:e,password:t,role:100});await a.save().catch(e=>{console.log(500,"服务器内部错误-存储admin错误！")})}}},function(e,t){function a(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}a.keys=function(){return[]},a.resolve=a,e.exports=a,a.id=19},function(e,t,a){"use strict";const s=a(21),r=a(22),n=a(23);a(24);e.exports=e=>{e.use(async(e,t)=>{const a=new Date;await t();const s=new Date-a;console.log(`${e.method} ${e.url} - ${s}ms`)}),e.use(n({origin:"*"})),e.use(r()),e.use(s({jsoinLimit:"10mb",formLimit:"10mb",textLimit:"10mb"})),e.use(async(e,t)=>{try{await t()}catch(t){e.body={error:t}}404!==e.status&&405!==e.status||(e.body={code:0,message:"无效的api请求"})})}},function(e,t){e.exports=require("koa-bodyparser")},function(e,t){e.exports=require("koa-helmet")},function(e,t){e.exports=require("koa-cors")},function(e,t,a){"use strict";const s=a(25);e.exports=async(e,t)=>{const a=e.request.headers.origin||"";if((["https://blog.naice.me","https://blog.admin.naice.me","file://"].includes(a)||a.includes("localhost"))&&e.set("Access-Control-Allow-Origin",a),e.set({"Access-Control-Allow-Headers":"Authorization, Origin, No-Cache, X-Requested-With, If-Modified-Since, Pragma, Last-Modified, Cache-Control, Expires, Content-Type, X-E4M-With","Access-Control-Allow-Methods":"PUT,PATCH,POST,GET,DELETE,OPTIONS","Access-Control-Max-Age":"1728000","Content-Type":"application/json;charset=utf-8","X-Powered-By":"naice_blog 1.0.0"}),"OPTIONS"==e.request.method)return e.status=200,!1;if(Object.is("development","production")){const{origin:t,referer:a}=e.request.headers;if("file://"!==t){if(!((!t||t.includes("naice.me"))&&(!a||a.includes("naice.me"))))return e.throw(403,{code:0,message:"身份验证失败！"}),!1}}const r=e.request.url.indexOf("/article/like")>=0&&Object.is(e.request.method,"POST"),n=e.request.url.indexOf("/comment/like")>=0&&Object.is(e.request.method,"POST"),i=e.request.url.indexOf("/user/login")>=0&&Object.is(e.request.method,"POST"),o=Object.is(e.request.url,"/api/hero/add")&&Object.is(e.request.method,"PUT"),c=Object.is(e.request.url,"/api/comment/add")&&Object.is(e.request.method,"PUT"),u=Object.is(e.request.url,"/api/reply/add")&&Object.is(e.request.method,"PUT");return r||n||c||i||o||u?(await t(),!1):s(e.request)||Object.is(e.request.method,"GET")?void await t():(e.throw(401,{code:-2,message:"身份验证失败！"}),!1)}},function(e,t,a){"use strict";const s=a(0),r=a(10);e.exports=e=>{const t=(e=>{if(e.headers&&e.headers.authorization){const t=e.headers.authorization.split(" ");if(Object.is(t.length,2)&&Object.is(t[0],"Naice"))return t[1]}return!1})(e);if(t)try{if(r.verify(t,s.User.jwtTokenSecret).exp>Math.floor(Date.now()/1e3))return!0}catch(e){console.log(e)}return!1}},function(e,t,a){const s=a(27),r=a(28),n=a(31),i=a(33),o=a(36),c=a(38),u=a(45),d=a(47),l=a(51),p=new s;n(p),r(p),i(p),o(p),c(p),u(p),d(p),l(p),e.exports=p},function(e,t){e.exports=require("koa-router")},function(e,t,a){"use strict";const s=a(0),{putTag:r,getTags:n,editTag:i,deleteTag:o}=a(29),{resError:c,resSuccess:u}=a(3),d=a(1),l=e=>`${s.APP.ROOT_PATH}/tag/${e}`;e.exports=function(e){e.put(l("add"),d(["name"]),async e=>{const{name:t,descript:a=""}=e.request.body;try{const s=await r({name:t,descript:a});u({ctx:e,message:"添加标签成功",result:s})}catch(t){c({ctx:e,message:"添加标签失败",err:t.message})}}),e.get(l("get"),async e=>{try{let t=await n();u({ctx:e,message:"获取标签成功",result:t})}catch(t){c({ctx:e,message:"获取标签失败",err:t})}}),e.del(l("delect/:id"),async e=>{const{id:t}=e.params;if(t)try{await o(t),u({ctx:e,message:"删除标签成功"})}catch(t){c({ctx:e,message:"删除标签失败",err:t})}else c({ctx:e,message:"删除标签失败",err:"缺少参数id"})}),e.post(l("edit"),d(["_id","name"]),async e=>{try{await i(e.request.body);u({ctx:e,message:"修改标签成功"})}catch(t){c({ctx:e,message:"修改标签失败",err:t})}})}},function(e,t,a){"use strict";const s=a(30),r=a(7);e.exports={putTag:async e=>{const{name:t}=e,a=await s.find({name:t});if(a&&0!==a.length)throw new Error("标签名已经存在");return(await new s(e)).save()},getTags:async(e={})=>{const{current_page:t=1,page_size:a=50,keyword:n=""}=e,i={sort:{sort:1},page:Number(t),limit:Number(a)};let o={};n&&(o.name=new RegExp(n));let c=[];const u=await s.paginate(o,i);if(u){let e=JSON.parse(JSON.stringify(u)),t={};const a=await r.aggregate([{$match:t},{$unwind:"$tag"},{$group:{_id:"$tag",num_tutorial:{$sum:1}}}]);a&&(e.docs.forEach(e=>{const t=a.find(t=>String(t._id)===String(e._id));e.count=t?t.num_tutorial:0}),c={pagination:{total:e.total,current_page:e.page,total_page:e.pages,page_size:e.limit},list:e.docs})}return c},editTag:async e=>{const{_id:t,name:a,descript:r}=e;return await s.findByIdAndUpdate(t,{name:a,descript:r},{new:!0})},deleteTag:async e=>await s.findByIdAndRemove(e)}},function(e,t,a){"use strict";const s=a(2),r=a(4),n=new s.Schema({name:{type:String,required:!0,validate:/\S+/},descript:String,create_at:{type:Date,default:Date.now},update_at:{type:Date},sort:{type:Number,default:0}});n.plugin(r),n.pre("findOneAndUpdate",function(e){this.findOneAndUpdate({},{update_at:Date.now()}),e()}),e.exports=s.model("Tag",n)},function(e,t,a){"use strict";const s=a(0),{putArticle:r,delectArticle:n,editeArticle:i,getArticleById:o,getArticles:c,changeArticleStatus:u,getAllArticles:d,likeArticle:l}=a(32),{resError:p,resSuccess:m}=a(3),g=a(1),y=e=>`${s.APP.ROOT_PATH}/article/${e}`;e.exports=function(e){e.put(y("add"),g(["title","tag","content","editContent","keyword","descript"]),async function(e,t){e.body="hello";const a=e.request.body;await r(a),m({ctx:e,message:"添加文章成功"})}),e.get(y("get"),async function(e,t){const a=e.query||{},s=await c(a);m({ctx:e,message:"查询文章成功",result:s})}),e.get(y("get/:id"),async function(e,t){const{id:a}=e.params;if(a)try{const t=await o(a);m({ctx:e,message:"查询文章成功",result:t})}catch(t){p({ctx:e,message:"查询文章失败",err:t})}else p({ctx:e,message:"查询文章失败",err:"缺少参数id"})}),e.del(y("delect/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await n(a);m({ctx:e,message:"删除文章成功"})}catch(t){p({ctx:e,message:"删除文章失败",err:t})}else p({ctx:e,message:"删除文章失败",err:"缺少参数id"})}),e.del(y("edite/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await i(a,e.request.body);m({ctx:e,message:"修改文章成功"})}catch(t){p({ctx:e,message:"修改文章失败",err:t})}else p({ctx:e,message:"修改文章失败",err:"地址缺少参数id"})}),e.get(y("getAll"),async function(e,t){const a=await d();m({ctx:e,message:"获取文章成功",result:a})}),e.post(y("status/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await u(a,e.request.body);m({ctx:e,message:"修改文章状态成功"})}catch(t){p({ctx:e,message:"修改文章状态失败",err:t})}else p({ctx:e,message:"修改文章状态失败",err:"地址缺少参数id"})}),e.post(y("like/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await l(a),m({ctx:e,message:"修改成功"})}catch(t){p({ctx:e,message:"修改失败",err:t})}else p({ctx:e,message:"修改失败",err:"地址缺少参数id"})})}},function(e,t,a){"use strict";const s=a(7);e.exports={putArticle:async e=>{let t=null;return e&&(t=await new s(e).save()),t},delectArticle:async e=>await s.findByIdAndRemove(e),editeArticle:async(e,t)=>await s.findByIdAndUpdate(e,t),getArticleById:async e=>{let t=await s.findById(e).populate("tag");return t&&(t.meta.views+=1,t=await t.save()),t},getArticles:async e=>{const{current_page:t=1,page_size:a=10,keyword:r="",state:n=1,publish:i=1,tag:o,type:c,date:u,hot:d}=e,l={sort:{create_at:-1},page:Number(t),limit:Number(a),populate:["tag"],select:"-content"},p={};if(r){const e=new RegExp(r);p.$or=[{title:e},{content:e},{description:e}]}if(["1","2"].includes(n)&&(p.state=n),["1","2"].includes(i)&&(p.publish=i),["1","2","3"].includes(c)&&(p.type=c),d&&(l.sort={"meta.views":-1,"meta.likes":-1,"meta.comments":-1}),u){const e=new Date(u);Object.is(e.toString(),"Invalid Date")||(p.create_at={$gte:new Date(1e3*(e/1e3-28800)),$lt:new Date(1e3*(e/1e3+57600))})}o&&(p.tag=o);const m=await s.paginate(p,l);return!!m&&{pagination:{total:m.total,current_page:m.page,total_page:m.pages,page_size:m.limit},list:m.docs}},changeArticleStatus:async(e,t)=>{const{state:a,publish:r}=t,n={};return a&&(n.state=a),r&&(n.publish=r),await s.findByIdAndUpdate(e,n)},likeArticle:async e=>{let t=await s.findById(e);return t&&(t.meta.likes+=1,t=await t.save()),t},getAllArticles:async()=>{Number(1),Number(1e4);const e=await s.aggregate([{$match:{state:1,publish:1}},{$project:{year:{$year:"$create_at"},month:{$month:"$create_at"},title:1,create_at:1}},{$group:{_id:{year:"$year",month:"$month"},article:{$push:{title:"$title",_id:"$_id",create_at:"$create_at"}}}}]);if(e){return[...new Set(e.map(e=>e._id.year))].map(t=>{let a=[];return e.forEach(e=>{e._id.year===t&&a.push({month:e._id.month,articleList:e.article.reverse()})}),{year:t,monthList:a}})}return[]}}},function(e,t,a){"use strict";const s=a(8),r=a(0),{putComment:n,delectComment:i,editeComment:o,getComment:c,likeComment:u}=a(34),{resError:d,resSuccess:l}=a(3),{sendMail:p}=a(13),m=a(1),g=`${r.APP.ROOT_PATH}/comment/`,y=e=>`${g}${e}`,f=e=>{p({to:`hewenlin1991@gmail.com, ${e.author.email}`,subject:"博客有新的留言",text:`来自 ${e.author.name} 的留言：${e.content}`,html:`<p> 来自 ${e.author.name} 的留言：${e.content}</p><br><a href="${e.permalink}" target="_blank">[ 点击查看 ]</a>`})};e.exports=function(e){e.put(y("add"),m(["post_id","content","author"]),async function(e,t){let a=e.request.body;a.content=s(a.content);try{let t=await n(e,a);f(t),l({ctx:e,message:"添加评论成功"})}catch(t){d({ctx:e,message:"添加评论失败",err:t})}}),e.get(y("get"),async function(e,t){try{const t=await c(e.query);l({ctx:e,message:"获取评论成功",result:t})}catch(t){d({ctx:e,message:"获取评论失败",err:t})}}),e.del(y("delect/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await i(a),l({ctx:e,message:"删除评论成功"})}catch(t){d({ctx:e,message:"删除评论失败",err:t})}else d({ctx:e,message:"删除评论失败",err:"缺少参数id"})}),e.post(y("edite/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await o(a,e.request.body),l({ctx:e,message:"修改评论成功"})}catch(t){d({ctx:e,message:"修改评论失败",err:t})}else d({ctx:e,message:"修改评论失败",err:"地址缺少参数id"})}),e.post(y("like/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await u(a);l({ctx:e,message:"修改成功"})}catch(t){d({ctx:e,message:"修改失败",err:t})}else d({ctx:e,message:"修改失败",err:"地址缺少参数id"})})}},function(e,t,a){"use strict";const s=a(7),r=a(11),n=a(12);e.exports={putComment:async(e,t)=>{const a=(e.req.headers["x-forwarded-for"]||e.req.headers["x-real-ip"]||e.req.connection.remoteAddress||e.req.socket.remoteAddress||e.req.connection.socket.remoteAddress||e.req.ip||e.req.ips[0]).replace("::ffff:","");t.ip=a||"14.215.177.38",t.agent=e.headers["user-agent"]||t.agent;const i=n.lookup(t.ip);i&&(t.city=i.city,t.range=i.range,t.country=i.country);let o="https://blog.naice.me/about",c=await s.findById({_id:t.post_id});c.meta.comments+=1,o=`https://blog.naice.me/article/${c._id}`;const u=await new r(t).save();return await c.save(),u.permalink=o,u},delectComment:async e=>await r.findByIdAndRemove(e),editeComment:async(e,t)=>await r.findByIdAndUpdate(e,t),likeComment:async e=>{let t=await r.findById(e);return t&&(t.likes+=1,t=await t.save()),t},getComment:async(e={})=>{let{sort:t=-1,current_page:a=1,page_size:s=10,keyword:n="",post_id:i,state:o}=e,c={};const u={sort:{_id:t=Number(t)},page:Number(a),limit:Number(s)};[1,-1].includes(t)?u.sort={_id:t}:Object.is(t,2)&&(u.sort={likes:-1});let d={};if(o&&["0","1","2"].includes(o)&&(d.state=o),n){const e=new RegExp(n);d.$or=[{content:e},{"author.name":e},{"author.email":e}]}Object.is(i,void 0)||(d.post_id=i);const l=await r.paginate(d,u);return l&&(c={pagination:{total:l.total,current_page:u.page,total_page:l.pages,per_page:u.limit},data:l.docs}),c}}},function(e,t){e.exports=require("nodemailer")},function(e,t,a){"use strict";const s=a(8),r=a(0),{putHero:n,delectHero:i,editeHero:o,getHero:c}=a(37),{resError:u,resSuccess:d}=a(3),l=a(1),p=`${r.APP.ROOT_PATH}/hero/`,m=e=>`${p}${e}`;e.exports=function(e){e.put(m("add"),l(["content","author"]),async function(e,t){let a=e.request.body;a.content=s(a.content);try{await n(e,a);d({ctx:e,message:"添加留言成功"})}catch(t){u({ctx:e,message:"添加留言失败",err:t})}}),e.get(m("get"),async function(e,t){try{const t=await c(e.query);d({ctx:e,message:"获取留言成功",result:t})}catch(t){u({ctx:e,message:"获取留言失败",err:t})}}),e.del(m("delect/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await i(a);d({ctx:e,message:"删除留言成功"})}catch(t){u({ctx:e,message:"删除留言失败",err:t})}else u({ctx:e,message:"删除留言失败",err:"缺少参数id"})}),e.post(m("edite/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await o(a,e.request.body);d({ctx:e,message:"修改留言成功"})}catch(t){u({ctx:e,message:"修改留言失败",err:t})}else u({ctx:e,message:"修改留言失败",err:"地址缺少参数id"})})}},function(e,t,a){"use strict";const s=rquire("geoip-lite"),r=rquire("../models/hero");e.exports={putHero:async(e,t)=>{const a=(e.req.headers["x-forwarded-for"]||e.req.headers["x-real-ip"]||e.req.connection.remoteAddress||e.req.socket.remoteAddress||e.req.connection.socket.remoteAddress||e.req.ip||e.req.ips[0]).replace("::ffff:","");t.ip=a||"14.215.177.38",t.agent=e.headers["user-agent"]||t.agent;const n=s.lookup(t.ip);return n&&(t.city=n.city,t.range=n.range,t.country=n.country),await new r(t).save()},delectHero:async e=>await r.findByIdAndRemove(e),editeHero:async(e,t)=>await r.findByIdAndUpdate(e,t),getHero:async(e={})=>{let{current_page:t=1,page_size:a=12,keyword:s="",state:n=1}=e,i={};const o={sort:{_id:-1},page:Number(t),limit:Number(a)},c={};return s&&(c.name=new RegExp(s)),["0","1","2"].includes(n)&&(c.state=Number(n)),i=(i=await r.paginate(c,o))?{pagination:{total:i.total,current_page:i.page,total_page:i.pages,page_size:i.limit},list:i.docs}:{}}}},function(e,t,a){"use strict";const s=a(0),{putMusic:r,delectMusic:n,editeMusic:i,getMusic:o,upload:c}=a(39),{resError:u,resSuccess:d}=a(3),l=a(1),p=`${s.APP.ROOT_PATH}/music/`,m=e=>`${p}${e}`;e.exports=function(e){e.put(m("add"),l(["title","name","url"]),async function(e,t){let a=e.request.body;try{await r(e,a),d({ctx:e,message:"添加音乐成功"})}catch(t){u({ctx:e,message:"添加音乐失败",err:t})}}),e.get(m("get"),async function(e,t){try{const t=await o(e.query);d({ctx:e,message:"获取音乐成功",result:t})}catch(t){u({ctx:e,message:"获取音乐失败",err:t})}}),e.del(m("delect/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await n(a),d({ctx:e,message:"删除音乐成功"})}catch(t){Í,u({ctx:e,message:"删除音乐失败",err:t})}else u({ctx:e,message:"删除音乐失败",err:"缺少参数id"})}),e.post(m("edite/:id"),async function(e,t){const{id:a}=e.params;if(a)try{const t=await i(a,e.request.body);d({ctx:e,result:t,message:"修改音乐成功"})}catch(t){u({ctx:e,message:"修改音乐失败",err:t})}else u({ctx:e,message:"修改音乐失败",err:"地址缺少参数id"})}),e.post(m("upload"),async function(e,t){try{const t=await c(e);d({ctx:e,message:"上传成功",result:`http://img.store.naice.me/${t.key}`})}catch(t){u({ctx:e,message:"上传失败",err:t})}})}},function(e,t,a){"use strict";(function(t){const s=a(5),r=a(40),{uploadFile:n,upToQiniu:i,removeTemFile:o}=a(41);e.exports={putMusic:async(e,t)=>await new r(t).save(),delectMusic:async e=>await r.findByIdAndRemove(e),editeMusic:async(e,t)=>await r.findByIdAndUpdate(e,t),getMusic:async(e={})=>{let{state:t="",id:a=""}=e;const s={};return["0","1","2"].includes(t)&&(s.state=Number(t)),a&&(s._id=a),await r.find(s)},upload:async e=>{const a=s.join(t,"../../uploadtemp/"),r=await n(e,{fileType:"poster",path:a}),c=s.join(a,r.imgPath),u=await i(c,r.imgKey);return o(c),u}}}).call(this,"/")},function(e,t,a){"use strict";const s=a(2),r=new s.Schema({title:{type:String},name:{type:String},poster:{type:String},lyrics:{type:String,required:!0,validate:/\S+/},state:{type:Number,default:1},url:{type:String},create_time:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now}});r.pre("findOneAndUpdate",function(e){this.findOneAndUpdate({},{update_at:Date.now()}),e()}),e.exports=s.model("Music",r)},function(e,t,a){const s=a(5),r=a(42),n=a(43),i=a(44),o=a(0),c=e=>!!r.existsSync(e)||!!c(s.dirname(e))&&(r.mkdirSync(e),!0);e.exports={removeTemFile:e=>{r.unlink(e,e=>{if(e)throw e})},upToQiniu:(e,t)=>{const a=o.QINIU.accessKey,s=o.QINIU.secretKey,r=new i.auth.digest.Mac(a,s),n={scope:o.QINIU.bucket},c=new i.rs.PutPolicy(n).uploadToken(r),u=new i.conf.Config;u.zone=i.zone.Zone_z2;const d=e,l=new i.form_up.FormUploader(u),p=new i.form_up.PutExtra;return new Promise((e,a)=>{l.putFile(c,t,d,p,function(t,s,r){t?a(t):e(s)})})},uploadFile:(e,t)=>{const a=new n({headers:e.req.headers}),i=t.fileType,o=s.join(t.path,i);if(c(o))return console.log("start uploading..."),new Promise((t,n)=>{a.on("file",function(e,a,n,c,u){const d=function(e){return Math.random().toString(32).substr(4)+"."+function(e){return e.split(".").pop()}(e)}(n),l=s.join(s.join(o,d));a.pipe(r.createWriteStream(l)),a.on("end",function(){t({imgPath:`/${i}/${d}`,imgKey:d})})}),a.on("finish",function(){console.log("finished...")}),a.on("error",function(e){console.log("err..."),n(e)}),e.req.pipe(a)})}}},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("busboy")},function(e,t){e.exports=require("qiniu")},function(e,t,a){"use strict";const s=a(10),r=a(6),n=a(0),{findOne:i}=a(46),{resError:o,resSuccess:c}=a(3),u=a(1),d=`${n.APP.ROOT_PATH}/user/`,l=e=>`${d}${e}`,p=e=>r.createHash("md5").update(e).digest("hex");e.exports=function(e){e.post(l("login"),u(["username","password"]),async function(e,t){const{username:a,password:r}=e.request.body;try{const t=await i(a);if(t)if(t.password===p(r)){const a=s.sign({name:t.name,password:t.password,exp:Math.floor(Date.now()/1e3)+604800},n.User.jwtTokenSecret);c({ctx:e,result:{token:a,lifeTime:Math.floor(Date.now()/1e3)+604800},message:"登陆成功"})}else o({ctx:e,message:"密码错误!"});else o({ctx:e,message:"账户不存在"})}catch(t){o({ctx:e,message:"查询内部失败",err:t})}})}},function(e,t,a){"use strict";const s=a(9);e.exports={signUp:async e=>await new s(e).save(),findOne:async e=>await s.findOne({username:e}).exec(),getUserInfo:async e=>await s.findOne({username:e},"name username slogan gravatar role"),edite:async(e={})=>{const{_id:t,name:a,username:r,slogan:n,gravatar:i,oldPassword:o,newPassword:c}=e,u=await s.findOne({username:r},"_id name slogan gravatar password role");if(u){if(u.password!==md5Decode(o))return new Error("密码不正确");{const e=""===c?o:c;let s=await Auth.findByIdAndUpdate(t,{_id:t,name:a,username:r,slogan:n,gravatar:i,password:md5Decode(e)},{new:!0});return auth?s:new Error("修改用户资料失败")}}return new Error("修改用户资料失败")}}},function(e,t,a){"use strict";const s=a(8),r=a(0),{putReply:n,delectReply:i,editeReply:o,getReplyById:c,changeReplyStatus:u,likeReply:d}=a(48),{resError:l,resSuccess:p}=a(3),{sendMail:m}=a(13),g=a(1),y=`${r.APP.ROOT_PATH}/reply/`,f=e=>`${y}${e}`,x=e=>{let t="hewenlin1991@gmail.com";e.to&&e.to.email?t+=`, ${e.from.email}, ${e.to.email}`:t+=`, ${e.from.email}`,m({to:t,subject:"你在blog.naice.me有新的评论回复",text:`来自 ${e.from.name} 的评论回复：${e.content}`,html:`<p> 来自${e.from.name} 的评论回复：${e.content}</p><br><a href="${e.permalink}" target="_blank">[ 点击查看 ]</a>`})};e.exports=function(e){e.put(f("add"),g(["post_id","cid","content","from"]),async function(e,t){let a=e.request.body;a.content=s(a.content);try{let t=await n(e,e.request.body);x(t),p({ctx:e,message:"添加评论成功"})}catch(t){l({ctx:e,message:"添加评论失败",err:t})}}),e.get(f("get/:id"),async function(e,t){const{id:a}=e.params;if(a)try{const t=await c(a,e.query);p({ctx:e,message:"获取回复成功",result:t})}catch(t){l({ctx:e,message:"获取回复失败",err:t})}else l({ctx:e,message:"获取回复失败",err:"缺少参数id"})}),e.del(f("delect/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await i(a);p({ctx:e,message:"删除成功"})}catch(t){l({ctx:e,message:"删除失败",err:t})}else l({ctx:e,message:"删除失败",err:"缺少参数id"})}),e.post(f("edite/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await o(a,e.request.body),p({ctx:e,message:"修改回复成功"})}catch(t){l({ctx:e,message:"修改回复失败",err:t})}else l({ctx:e,message:"修改回复失败",err:"地址缺少参数id"})}),e.post(f("status/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await u(a,e.request.body);p({ctx:e,message:"修改回复态成功"})}catch(t){l({ctx:e,message:"修改回复状态失败",err:t})}else l({ctx:e,message:"修改评回复态失败",err:"地址缺少参数id"})}),e.post(f("like/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await d(a);p({ctx:e,message:"修改成功"})}catch(t){l({ctx:e,message:"修改状态失败",err:t})}else l({ctx:e,message:"修改失败",err:"地址缺少参数id"})})}},function(e,t,a){"use strict";const s=a(12),r=a(49),n=a(11);e.exports={putReply:async(e,t)=>{const a=(e.req.headers["x-forwarded-for"]||e.req.headers["x-real-ip"]||e.req.connection.remoteAddress||e.req.socket.remoteAddress||e.req.connection.socket.remoteAddress||e.req.ip||e.req.ips[0]).replace("::ffff:","");t.ip=a||"14.215.177.38",t.agent=e.headers["user-agent"]||t.agent;const i=s.lookup(t.ip);i&&(t.city=i.city,t.range=i.range,t.country=i.country),t.likes=0;const o=await new r(t).save();let c="https://blog.naice.me";t.post_id&&(c=`https://blog.naice.me/article/${t.post_id}`);let u=await n.findOne({_id:t.cid});return u&&(u.reply+=1,await u.save()),o.permalink=c,o},delectReply:async e=>await r.findByIdAndRemove(e),editeReply:async(e,t)=>await r.findByIdAndUpdate(e,t),likeReply:async e=>{let t=await r.findById(e);t&&(t.likes+=1,await t.save())},getReplyById:async(e,t={})=>{let{sort:a=-1,current_page:s=1,page_size:n=20,keyword:i="",post_id:o,state:c}=t,u={};const d={sort:{_id:a=Number(a)},page:Number(s),limit:Number(n)};[1,-1].includes(a)?d.sort={_id:a}:Object.is(a,2)&&(d.sort={likes:-1});let l={cid:e};if(c&&["0","1","2"].includes(c)&&(l.state=c),i){const e=new RegExp(i);l.$or=[{content:e},{"to.name":e},{"to.email":e}]}const p=await r.paginate(l,d);return p&&(u={pagination:{total:p.total,current_page:p.page,total_page:p.pages,per_page:p.limit},data:p.docs}),u},changeReplyStatus:async(e,t)=>await r.findByIdAndUpdate(e,{state:t})}},function(e,t,a){"use strict";const s=a(2),r=a(4),n=a(50);n.initialize(s.connection);const i=new s.Schema({post_id:{type:String,required:!0},cid:{type:String,required:!0},from:{gravatar:{type:String,default:""},name:{type:String,required:!0,validate:/\S+/},email:{type:String,required:!0,validate:/\w[-\w.+]*@([A-Za-z0-9][-A-Za-z0-9]+\.)+[A-Za-z]{2,14}/},site:{type:String}},to:{gravatar:{type:String,default:""},name:{type:String,validate:/\S+/},email:{type:String,validate:/\w[-\w.+]*@([A-Za-z0-9][-A-Za-z0-9]+\.)+[A-Za-z]{2,14}/},site:{type:String}},content:{type:String,required:!0,validate:/\S+/},likes:{type:Number,default:0},ip:{type:String},city:{type:String},range:{type:String},country:{type:String},agent:{type:String,validate:/\S+/},state:{type:Number,default:1},create_at:{type:Date,default:Date.now},update_at:{type:Date}});i.plugin(r),i.plugin(n.plugin,{model:"Reply",field:"id",startAt:1,incrementBy:1}),i.pre("findOneAndUpdate",function(e){this.findOneAndUpdate({},{update_at:Date.now()}),e()}),e.exports=s.model("Reply",i)},function(e,t){e.exports=require("mongoose-auto-increment")},function(e,t,a){"use strict";const s=requir("../config"),{putProject:r,delectProject:n,editeProject:i,getProjectById:o,getProjects:c}=requir("../controllers/project"),{resError:u,resSuccess:d}=requir("../utils/resHandle"),l=a(1),p=`${s.APP.ROOT_PATH}/project/`,m=e=>`${p}${e}`;e.exports=function(e){e.put(m("add"),l(["title","icon","view","github"]),async function(e,t){const a=e.request.body;await r(a),d({ctx:e,message:"添加项目成功"})}),e.get(m("get"),async function(e,t){const a=e.query||{},s=await c(a);d({ctx:e,message:"查询项目成功",result:s})}),e.get(m("get/id"),async function(e,t){const{id:a}=e.params;if(a)try{const t=await o(a);d({ctx:e,message:"查询项目成功",result:t})}catch(t){u({ctx:e,message:"查询项目失败",err:t})}else u({ctx:e,message:"查询项目失败",err:"缺少参数id"})}),e.del(m("delect/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await n(a);d({ctx:e,message:"删除项目成功"})}catch(t){u({ctx:e,message:"删除项目失败",err:t})}else u({ctx:e,message:"删除项目失败",err:"缺少参数id"})}),e.post(m("edite/:id"),async function(e,t){const{id:a}=e.params;if(a)try{await i(a,e.request.body);d({ctx:e,message:"修改项目成功"})}catch(t){u({ctx:e,message:"修改项目失败",err:t})}else u({ctx:e,message:"修改项目失败",err:"地址缺少参数id"})})}}]);